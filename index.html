<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Crop & Cut Tool</title>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: none;
        }

        .toolbar {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toolbar button {
            touch-action: manipulation; /* disable double tap to zoom */
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .toolbar button:active {
            transform: scale(0.95);
        }

        .toolbar button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        .upload-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .upload-box {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            max-width: 400px;
        }

        .upload-box:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-box input {
            display: none;
        }

        .image-container {
            flex: 1;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: auto;
        }

        .image-container.active {
            display: flex;
        }

        .image-wrapper {
            position: relative;
            display: inline-block;
            max-width: 100%;
            max-height: 100%;
        }

        .image-wrapper img {
            display: block;
            max-width: 100%;
            max-height: calc(100vh - 120px);
            height: auto;
            user-select: none;
            -webkit-user-drag: none;
        }

        .selection-overlay {
            position: absolute;
            pointer-events: none;
        }

        .handle {
            position: absolute;
            background: white;
            border: 2px solid black;
            cursor: grab;
            pointer-events: auto;
            z-index: 10;
            transition: opacity 0.2s;
        }

        .handle:active {
            cursor: grabbing;
        }

        .handle.disabled {
            opacity: 0;
            pointer-events: none;
        }

        .handle-top, .handle-bottom {
            width: 60px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 6px;
        }

        .handle-top {
            top: -6px;
        }

        .handle-bottom {
            bottom: -6px;
        }

        .handle-left, .handle-right {
            width: 20px;
            height: 60px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 6px;
        }

        .handle-left {
            left: -6px;
        }

        .handle-right {
            right: -6px;
        }

        .selection-border {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid white;
            box-shadow: 0 0 0 1px black inset, 0 0 0 1px black;
            pointer-events: none;
        }

        .border-top, .border-bottom {
            height: 2px;
            left: 0;
            right: 0;
        }

        .border-top {
            top: 0;
        }

        .border-bottom {
            bottom: 0;
        }

        .border-left, .border-right {
            width: 2px;
            top: 0;
            bottom: 0;
        }

        .border-left {
            left: 0;
        }

        .border-right {
            right: 0;
        }

        @media (min-width: 768px) {
            .toolbar button {
                width: 56px;
                height: 56px;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="undoBtn" disabled title="Undo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 7v6h6M21 17a9 9 0 00-9-9 9 9 0 00-9 9"/>
            </svg>
        </button>
        <button id="redoBtn" disabled title="Redo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 7v6h-6M3 17a9 9 0 019-9 9 9 0 019 9"/>
            </svg>
        </button>
        <button id="cropBtn" disabled title="Crop">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2v14a2 2 0 002 2h14M18 22V8a2 2 0 00-2-2H2"/>
            </svg>
        </button>
        <button id="cutBtn" disabled title="Cut">
         <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/>
                <line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/>
            </svg>
        </button>
        <a id="downloadImageLink">
            <button id="shareBtn" disabled title="Share">
                <svg id="shareIcon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                </svg>
            </button>
        </a>
    </div>

    <div class="upload-area" id="uploadArea">
        <div class="upload-box" id="uploadBox">
            <input type="file" id="fileInput" accept="image/*">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 16px;">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
            <div style="font-size: 18px; margin-bottom: 8px;">Upload an image</div>
            <div style="font-size: 14px; opacity: 0.7;">Tap to select a file</div>
        </div>
    </div>

    <div class="image-container" id="imageContainer">
        <div class="image-wrapper" id="imageWrapper">
            <img id="displayImage" alt="Uploaded image">
            <div class="selection-overlay" id="selectionOverlay">
                <div class="selection-border"></div>
                <div class="handle handle-top" id="handleTop"></div>
                <div class="handle handle-bottom" id="handleBottom"></div>
                <div class="handle handle-left" id="handleLeft"></div>
                <div class="handle handle-right" id="handleRight"></div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const uploadBox = document.getElementById('uploadBox');
        const uploadArea = document.getElementById('uploadArea');
        const imageContainer = document.getElementById('imageContainer');
        const displayImage = document.getElementById('displayImage');
        const selectionOverlay = document.getElementById('selectionOverlay');
        const imageWrapper = document.getElementById('imageWrapper');

        const handleTop = document.getElementById('handleTop');
        const handleBottom = document.getElementById('handleBottom');
        const handleLeft = document.getElementById('handleLeft');
        const handleRight = document.getElementById('handleRight');

        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const cutBtn = document.getElementById('cutBtn');
        const cropBtn = document.getElementById('cropBtn');
        const shareBtn = document.getElementById('shareBtn');
        const shareIcon = document.getElementById('shareIcon');
        const downloadImageLink = document.getElementById('downloadImageLink');

        let state = {
            _currentImageData: null,
            blob: null,
            file: null,
            set currentImageData(newValue) {
                this._currentImageData = newValue;
                useLoadingIcon();
                getImageBlob()
                    .then(blob => {
                        this.blob = blob;
                        updateDownloadImageLink();
                        this.file = new File([state.blob], 'edited-image.png', { type: 'image/png' });
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [this.file] })) {
                            useShareTrayIcon();
                            shareBtn.addEventListener('click', performShare);
                        } else {
                            useDownloadIcon();
                            shareBtn.removeEventListener('click', performShare);
                        }
                    });
            },
            get currentImageData() {
                return this._currentImageData;
            },
        }
        let selection = { top: 0, bottom: 1, left: 0, right: 1 };
        let dragging = null;
        let dragStart = { x: 0, y: 0, value: 0 };
        let undoStack = [];
        let redoStack = [];

        uploadBox.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result);
            };
            reader.readAsDataURL(file);
        }

        function loadImage(dataUrl) {
            state.currentImageData = dataUrl;
            displayImage.src = dataUrl;
            displayImage.onload = () => {
                uploadArea.style.display = 'none';
                imageContainer.classList.add('active');
                resetSelection();
                updateButtons();
            };
        }

        function resetSelection() {
            selection = { top: 0, bottom: 1, left: 0, right: 1 };
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const rect = displayImage.getBoundingClientRect();
            const wrapperRect = imageWrapper.getBoundingClientRect();
            const imgWidth = displayImage.offsetWidth;
            const imgHeight = displayImage.offsetHeight;

            const top = selection.top * imgHeight;
            const bottom = selection.bottom * imgHeight;
            const left = selection.left * imgWidth;
            const right = selection.right * imgWidth;

            selectionOverlay.style.top = top + 'px';
            selectionOverlay.style.left = left + 'px';
            selectionOverlay.style.width = (right - left) + 'px';
            selectionOverlay.style.height = (bottom - top) + 'px';

            updateHandleStates();
        }

        function updateHandleStates() {
            const topAtEdge = selection.top === 0;
            const bottomAtEdge = selection.bottom === 1;
            const leftAtEdge = selection.left === 0;
            const rightAtEdge = selection.right === 1;

            const allAtEdges = topAtEdge && bottomAtEdge && leftAtEdge && rightAtEdge;

            // When all at edges, enable all handles (user can drag any direction)
            if (allAtEdges) {
                handleTop.classList.remove('disabled');
                handleBottom.classList.remove('disabled');
                handleLeft.classList.remove('disabled');
                handleRight.classList.remove('disabled');
            } else if (topAtEdge && bottomAtEdge) {
                // Full height selection - enable left/right
                handleLeft.classList.remove('disabled');
                handleRight.classList.remove('disabled');
                handleTop.classList.add('disabled');
                handleBottom.classList.add('disabled');
            } else if (leftAtEdge && rightAtEdge) {
                // Full width selection - enable top/bottom
                handleTop.classList.remove('disabled');
                handleBottom.classList.remove('disabled');
                handleLeft.classList.add('disabled');
                handleRight.classList.add('disabled');
            }

            // Disable cut and crop when all handles are at edges
            cutBtn.disabled = allAtEdges || !state.currentImageData;
            cropBtn.disabled = allAtEdges || !state.currentImageData;
        }

        function startDrag(handle, e) {
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            dragging = handle;
            dragStart.x = clientX;
            dragStart.y = clientY;

            if (handle === 'top') dragStart.value = selection.top;
            else if (handle === 'bottom') dragStart.value = selection.bottom;
            else if (handle === 'left') dragStart.value = selection.left;
            else if (handle === 'right') dragStart.value = selection.right;
        }

        function handleDrag(e) {
            if (!dragging) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const imgRect = displayImage.getBoundingClientRect();
            const imgWidth = displayImage.offsetWidth;
            const imgHeight = displayImage.offsetHeight;

            if (dragging === 'top' || dragging === 'bottom') {
                let relY = (clientY - imgRect.top) / imgHeight;
                
                if (clientY < imgRect.top) relY = 0;
                if (clientY > imgRect.bottom) relY = 1;
                
                relY = Math.max(0, Math.min(1, relY));

                if (dragging === 'top') {
                    selection.top = Math.min(relY, selection.bottom - 0.01);
                } else {
                    selection.bottom = Math.max(relY, selection.top + 0.01);
                }
            } else {
                let relX = (clientX - imgRect.left) / imgWidth;
                
                if (clientX < imgRect.left) relX = 0;
                if (clientX > imgRect.right) relX = 1;
                
                relX = Math.max(0, Math.min(1, relX));

                if (dragging === 'left') {
                    selection.left = Math.min(relX, selection.right - 0.01);
                } else {
                    selection.right = Math.max(relX, selection.left + 0.01);
                }
            }

            updateSelectionUI();
        }

        function endDrag() {
            if (!dragging) return;

            let currentValue;
            if (dragging === 'top') currentValue = selection.top;
            else if (dragging === 'bottom') currentValue = selection.bottom;
            else if (dragging === 'left') currentValue = selection.left;
            else if (dragging === 'right') currentValue = selection.right;

            if (Math.abs(currentValue - dragStart.value) > 0.001) {
                undoStack.push({
                    type: 'move',
                    handle: dragging,
                    value: dragStart.value
                });
                redoStack = [];
                updateButtons();
            }

            dragging = null;
            updateHandleStates();
        }

        handleTop.addEventListener('mousedown', (e) => startDrag('top', e));
        handleBottom.addEventListener('mousedown', (e) => startDrag('bottom', e));
        handleLeft.addEventListener('mousedown', (e) => startDrag('left', e));
        handleRight.addEventListener('mousedown', (e) => startDrag('right', e));

        handleTop.addEventListener('touchstart', (e) => startDrag('top', e));
        handleBottom.addEventListener('touchstart', (e) => startDrag('bottom', e));
        handleLeft.addEventListener('touchstart', (e) => startDrag('left', e));
        handleRight.addEventListener('touchstart', (e) => startDrag('right', e));

        window.addEventListener('mousemove', handleDrag);
        window.addEventListener('touchmove', handleDrag, { passive: false });
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);

        cutBtn.addEventListener('click', performCut);
        cropBtn.addEventListener('click', performCrop);
        undoBtn.addEventListener('click', performUndo);
        redoBtn.addEventListener('click', performRedo);

        async function performCut() {
            const img = new Image();
            img.src = state.currentImageData;
            await img.decode();

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const isHorizontalCut = selection.left === 0 && selection.right === 1;

            if (isHorizontalCut) {
                const topHeight = Math.round(selection.top * img.height);
                const bottomHeight = Math.round((1 - selection.bottom) * img.height);
                
                canvas.width = img.width;
                canvas.height = topHeight + bottomHeight;

                if (topHeight > 0) {
                    ctx.drawImage(img, 0, 0, img.width, topHeight, 0, 0, img.width, topHeight);
                }
                if (bottomHeight > 0) {
                    ctx.drawImage(img, 0, selection.bottom * img.height, img.width, bottomHeight, 0, topHeight, img.width, bottomHeight);
                }
            } else {
                const leftWidth = Math.round(selection.left * img.width);
                const rightWidth = Math.round((1 - selection.right) * img.width);
                
                canvas.width = leftWidth + rightWidth;
                canvas.height = img.height;

                if (leftWidth > 0) {
                    ctx.drawImage(img, 0, 0, leftWidth, img.height, 0, 0, leftWidth, img.height);
                }
                if (rightWidth > 0) {
                    ctx.drawImage(img, selection.right * img.width, 0, rightWidth, img.height, leftWidth, 0, rightWidth, img.height);
                }
            }

            undoStack.push({
                type: 'cut',
                imageData: state.currentImageData,
                selection: { ...selection }
            });
            redoStack = [];

            state.currentImageData = canvas.toDataURL();
            displayImage.src = state.currentImageData;
            resetSelection();
            updateButtons();
        }

        async function performCrop() {
            const img = new Image();
            img.src = state.currentImageData;
            await img.decode();

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const sx = selection.left * img.width;
            const sy = selection.top * img.height;
            const sWidth = (selection.right - selection.left) * img.width;
            const sHeight = (selection.bottom - selection.top) * img.height;

            canvas.width = sWidth;
            canvas.height = sHeight;

            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);

            undoStack.push({
                type: 'crop',
                imageData: state.currentImageData,
                selection: { ...selection }
            });
            redoStack = [];

            state.currentImageData = canvas.toDataURL();
            displayImage.src = state.currentImageData;
            resetSelection();
            updateButtons();
        }

        function performUndo() {
            if (undoStack.length === 0) return;

            const action = undoStack.pop();
            
            if (action.type === 'move') {
                const currentValue = selection[action.handle];
                selection[action.handle] = action.value;
                redoStack.push({
                    type: 'move',
                    handle: action.handle,
                    value: currentValue
                });
                updateSelectionUI();
            } else if (action.type === 'cut' || action.type === 'crop') {
                redoStack.push({
                    type: action.type,
                    imageData: state.currentImageData,
                    selection: { ...selection }
                });
                state.currentImageData = action.imageData;
                displayImage.src = state.currentImageData;
                selection = { ...action.selection };
                displayImage.onload = () => updateSelectionUI();
            }

            updateButtons();
        }

        function performRedo() {
            if (redoStack.length === 0) return;

            const action = redoStack.pop();
            
            if (action.type === 'move') {
                const currentValue = selection[action.handle];
                selection[action.handle] = action.value;
                undoStack.push({
                    type: 'move',
                    handle: action.handle,
                    value: currentValue
                });
                updateSelectionUI();
            } else if (action.type === 'cut' || action.type === 'crop') {
                undoStack.push({
                    type: action.type,
                    imageData: state.currentImageData,
                    selection: { ...selection }
                });
                state.currentImageData = action.imageData;
                displayImage.src = state.currentImageData;
                selection = { ...action.selection };
                displayImage.onload = () => updateSelectionUI();
            }

            updateButtons();
        }

        function useLoadingIcon() {
            shareIcon.innerHTML = '<circle cx="12" cy="12" r="10" stroke-opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"/>';
            shareIcon.classList.add('spinning');
        }

        function useDownloadIcon() {
            shareIcon.innerHTML = '<path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>';
            shareIcon.classList.remove('spinning');
        }

        function useShareTrayIcon() {
            shareIcon.innerHTML = '<path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>';
            shareIcon.classList.remove('spinning');
        }

        function performShare(e) {
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [state.file] })) {
                e.preventDefault();
                e.stopPropagation();
                useDownloadIcon();
                navigator
                    .share({
                        files: [state.file]
                    })
                    .catch(err => {
                        if (err.name !== 'AbortError') {
                            downloadImage();
                        }
                    })
                    .finally(() => {
                        useShareTrayIcon();
                    });
            } else {
                downloadImage();
            }
        }

        function downloadImage() {
            updateDownloadImageLink();
            downloadImageLink.click();
        }

        async function getImageBlob() {
            const response = await fetch(state.currentImageData);
            const blob = await response.blob();
            return blob;
        }

        function updateDownloadImageLink() {
            const blobUrl = URL.createObjectURL(state.blob);
            downloadImageLink.href = blobUrl;
        }

        function updateButtons() {
            const allAtEdges = selection.top === 0 && selection.bottom === 1 && 
                              selection.left === 0 && selection.right === 1;
            
            undoBtn.disabled = undoStack.length === 0;
            redoBtn.disabled = redoStack.length === 0;
            cutBtn.disabled = !state.currentImageData || allAtEdges;
            cropBtn.disabled = !state.currentImageData || allAtEdges;
            shareBtn.disabled = !state.currentImageData;
        }

        window.addEventListener('resize', () => {
            if (state.currentImageData) {
                updateSelectionUI();
            }
        });

        displayImage.addEventListener('load', () => {
            updateSelectionUI();
        });
    </script>
</body>
</html>
